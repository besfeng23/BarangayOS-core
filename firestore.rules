
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions for secure, readable rules
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isSuperAdmin() {
        return isSignedIn() && request.auth.token.role == 'superadmin';
    }

    function isRole(role) {
      return isSignedIn() && request.auth.token.role == role;
    }

    function isRoleIn(roles) {
      return isSignedIn() && request.auth.token.role in roles;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isSameBarangay(barangayId) {
      return isSignedIn() && request.auth.token.barangayId == barangayId;
    }

    //------------------------------------------------------------
    // User Profiles
    //------------------------------------------------------------
    match /userProfiles/{userId} {
      // Users can read/create their own profile.
      allow read, create: if isOwner(userId);
      // Users can update their own profile, but cannot change their role or barangayId.
      allow update: if isOwner(userId) 
                    && !('role' in request.resource.data) 
                    && !('barangayId' in request.resource.data);
      // A captain can read profiles within their own barangay.
      allow get: if isRole('barangay_captain') && isSameBarangay(resource.data.barangayId);
      // Superadmin can read/write any profile (for administrative changes).
      allow read, write: if isSuperAdmin();
    }

    //------------------------------------------------------------
    // Barangay-Scoped Data
    // All data is nested under a `barangays` collection to enforce tenant isolation.
    //------------------------------------------------------------
    match /barangays/{barangayId} {
      // The barangay document itself is read-only for most users.
      allow get: if isSameBarangay(barangayId);
      allow write: if isSuperAdmin(); // Only superadmins can edit barangay details.

      // Subcollections for each data type. These rules inherit the parent `barangayId`.
      match /residents/{residentId} {
        // Any authenticated user from the same barangay can read resident data.
        allow read: if isSameBarangay(barangayId);
        // Only secretary or captain can create/update resident records.
        allow write: if isSameBarangay(barangayId) && isRoleIn(['barangay_secretary', 'barangay_captain']);
      }
      
      match /blotter_cases/{caseId} {
        allow read, write: if isSameBarangay(barangayId) && isRoleIn(['barangay_secretary', 'barangay_captain']);
      }

      match /business_permits/{permitId} {
        allow read, write: if isSameBarangay(barangayId) && isRoleIn(['barangay_secretary', 'barangay_captain', 'treasurer']);
      }

      match /transactions/{transactionId} {
        allow read, write: if isSameBarangay(barangayId) && isRoleIn(['barangay_secretary', 'barangay_captain', 'treasurer']);
      }
      
      // Configuration for a specific barangay
      match /config/{docId} {
        allow read: if isSameBarangay(barangayId);
        allow write: if isSameBarangay(barangayId) && isRoleIn(['barangay_captain']);
      }
    }
    
    // By default, deny all other reads and writes.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
