rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // By default, deny all reads and writes.
    match /{document=**} {
      allow read, write: if false;
    }

    //------------------------------------------------------------
    // User Profiles
    //------------------------------------------------------------
    // - A user can read their own profile.
    // - A user can create their own profile upon signup.
    // - A user can update their own profile (but not change their role).
    // - Admins (captain/superadmin) can read/list profiles within their own barangay.
    // - Only superadmins can create/update the 'role' field.
    match /userProfiles/{userId} {
      allow read: if request.auth != null && (
                    request.auth.uid == userId ||
                    get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.role in ['captain', 'superadmin'] &&
                    get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.barangayId == resource.data.barangayId
                  );
                  
      allow create: if request.auth != null && request.auth.uid == userId;

      allow update: if request.auth != null && request.auth.uid == userId && !('role' in request.resource.data);

      // Superadmin can update any profile, including roles.
      allow write: if request.auth != null &&
                      get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.role == 'superadmin';
    }

    //------------------------------------------------------------
    // Barangay-Scoped Data (Residents, Blotter, Permits)
    //------------------------------------------------------------
    // - Authenticated users can only read/write data that belongs to their own barangay.
    // - This rule depends on the user's profile document having a 'barangayId'.
    function isUserInBarangay(barangayId) {
      return request.auth != null &&
             get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.barangayId == barangayId;
    }

    match /residents/{residentId} {
      allow read, write: if isUserInBarangay(resource.data.barangayId);
      allow create: if isUserInBarangay(request.resource.data.barangayId);
    }
    
    match /blotter_cases/{caseId} {
       allow read, write: if isUserInBarangay(resource.data.barangayId);
       allow create: if isUserInBarangay(request.resource.data.barangayId);
    }

    match /business_permits/{permitId} {
       allow read, write: if isUserInBarangay(resource.data.barangayId);
       allow create: if isUserInBarangay(request.resource.data.barangayId);
    }
    
    // Add other barangay-scoped collections here following the same pattern.
  }
}
