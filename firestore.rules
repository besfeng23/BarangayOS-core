rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // By default, deny all reads and writes.
    match /{document=**} {
      allow read, write: if false;
    }

    //------------------------------------------------------------
    // User Profiles
    //------------------------------------------------------------
    // - A user can read/write their own profile.
    // - An admin (captain/superadmin) can read profiles within their own barangay.
    // - A superadmin can write to any user profile (for role changes).
    match /userProfiles/{userId} {
      function isOwner() {
        return request.auth.uid == userId;
      }
      function isSuperAdmin() {
        return get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.role == 'superadmin';
      }
      function isAdminInSameBarangay() {
        let userProfile = get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data;
        return userProfile.role in ['captain', 'superadmin'] && userProfile.barangayId == resource.data.barangayId;
      }

      allow read: if request.auth != null && (isOwner() || isAdminInSameBarangay());
      allow create: if isOwner();
      // Allow user to update their own profile, but not their role or barangayId
      allow update: if isOwner() && !('role' in request.resource.data) && !('barangayId' in request.resource.data);
      // Allow superadmin to update any field
      allow write: if request.auth != null && isSuperAdmin();
    }
    
    //------------------------------------------------------------
    // Barangay-Scoped Data
    //------------------------------------------------------------
    // Helper function to check if the authenticated user belongs to the specified barangay.
    function isUserInBarangay(barangayId) {
      return request.auth != null &&
             get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.barangayId == barangayId;
    }

    // All data is nested under a `barangays` collection.
    match /barangays/{barangayId} {
      // Allow reads/writes if the user is part of that barangay.
      // This rule is inherited by all subcollections.
      allow read, write: if isUserInBarangay(barangayId);
      
      // Subcollections for each data type.
      match /residents/{residentId} {
        // No extra rules needed, inherits from parent.
        allow read, write: if true;
      }
      
      match /blotter_cases/{caseId} {
        allow read, write: if true;
      }

      match /business_permits/{permitId} {
        allow read, write: if true;
      }

      match /transactions/{transactionId} {
        allow read, write: if true;
      }

      match /config/{docId} {
        // e.g., /barangays/{barangayId}/config/identity
        allow read, write: if isUserInBarangay(barangayId);
      }
    }
  }
}
